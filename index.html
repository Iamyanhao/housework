<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KAJI-LOG Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f1f5f9; color: #1e293b; margin: 0; -webkit-tap-highlight-color: transparent; }
        .screen { display: none; min-height: 100vh; width: 100%; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <!-- 1. ログイン画面 -->
    <div id="screen-login" class="screen active">
        <div class="w-full max-w-sm bg-white rounded-[2.5rem] p-8 shadow-2xl space-y-6 animate-pop border border-slate-100">
            <div class="text-center">
                <div class="inline-block px-3 py-1 bg-indigo-100 text-indigo-600 text-[10px] font-black rounded-full mb-2 tracking-widest uppercase">System Secured</div>
                <h1 class="text-4xl font-black italic text-slate-900 tracking-tighter">KAJI-LOG</h1>
                <p class="text-slate-400 text-[10px] font-bold tracking-[0.3em] uppercase mt-2">Home Activity Tracker</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-3">GROUP ID</label>
                    <input id="group-id" type="text" placeholder="例: tanaka-home" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-400 outline-none transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 ml-3">USER NAME</label>
                    <input id="user-name" type="text" placeholder="あなたの名前" class="w-full p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-400 outline-none transition-all">
                </div>
                <button onclick="performLogin()" id="login-btn" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-all">
                    ログイン
                </button>
            </div>
            
            <div id="status-container" class="text-center space-y-2">
                <p id="auth-status" class="text-[10px] text-slate-300 font-bold uppercase tracking-widest">Ready to sync</p>
                <div id="error-log" class="hidden text-[10px] text-rose-500 bg-rose-50 p-3 rounded-xl font-mono text-left leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- 2. メイン画面 -->
    <div id="screen-main" class="screen flex-col !justify-start !p-0 bg-slate-50">
        <header class="w-full p-6 bg-white border-b border-slate-100 flex flex-col items-center space-y-4 shadow-sm sticky top-0 z-10 glass">
            <div class="w-full flex justify-between items-center px-2">
                <span class="text-[9px] font-black text-slate-300 tracking-widest" id="ver-display"></span>
                <button onclick="logout()" class="text-[10px] font-bold text-slate-400 hover:text-rose-500 transition-colors uppercase flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
            <div class="text-center pb-2">
                <p id="main-group-display" class="text-[10px] font-black text-indigo-500 uppercase tracking-[0.3em] mb-1"></p>
                <h1 id="main-user-display" class="text-3xl font-black text-slate-900 tracking-tight"></h1>
            </div>
            <div id="login-time-display" class="text-[9px] font-bold text-slate-400 px-4 py-1.5 bg-slate-100 rounded-full"></div>
        </header>
        
        <main class="p-6 w-full max-w-md space-y-6">
            <div class="bg-indigo-600 p-8 rounded-[2.5rem] shadow-2xl text-white relative overflow-hidden animate-pop">
                <div class="relative z-10">
                    <p class="text-xs font-bold opacity-70 mb-1 uppercase tracking-widest">System Status</p>
                    <h2 class="text-2xl font-black leading-tight">認証に成功しました<br>記録を開始できます</h2>
                </div>
                <div class="absolute -right-4 -bottom-4 opacity-10">
                    <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.9L9.03 9.06a1 1 0 00.939 0L16.836 4.9A1 1 0 0118 5.774V14.5a1 1 0 01-1 1H3a1 1 0 01-1-1V5.774a1 1 0 011.166-.874z" clip-rule="evenodd"></path></svg>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div class="p-6 bg-white rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 mb-1">Total Logs</p>
                        <p class="text-2xl font-black">--</p>
                    </div>
                    <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-slate-300 font-black italic">!</div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase設定（ここにあなたの情報を貼り付けてください） ---
        const VERSION_ID = "v1.1.0-release";
        const firebaseConfig = {
                    // --- ここを自分の情報に書き換える ---
        const firebaseConfig = {
  apiKey: "AIzaSyAVnIWuGLZdlx2MsyLAfsDgQ2zVkvh8JSc",
  authDomain: "kajilog-135ed.firebaseapp.com",
  projectId: "kajilog-135ed",
  storageBucket: "kajilog-135ed.firebasestorage.app",
  messagingSenderId: "506522172088",
  appId: "1:506522172088:web:c3fe4ad929fc067151d24d",
  measurementId: "G-SB0N9YCRTS"

        };

        const statusEl = document.getElementById('auth-status');
        const errorEl = document.getElementById('error-log');
        const btn = document.getElementById('login-btn');

        let db = null;
        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Initialization Error", e);
        }

        window.onload = () => {
            const savedGroup = localStorage.getItem('kajilog_group');
            const savedUser = localStorage.getItem('kajilog_user');
            if (savedGroup && savedUser) {
                document.getElementById('group-id').value = savedGroup;
                document.getElementById('user-name').value = savedUser;
                performLogin(true);
            }
        };

        window.performLogin = async (isAuto = false) => {
            const group = document.getElementById('group-id').value.trim();
            const user = document.getElementById('user-name').value.trim();

            if (!group || !user) return;

            btn.disabled = true;
            statusEl.innerText = isAuto ? "セッションを再開中..." : "アクセスを認証中...";
            errorEl.classList.add('hidden');

            try {
                let ip = "0.0.0.0";
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const data = await res.json();
                    ip = data.ip;
                } catch(e) { console.warn("IP取得失敗"); }

                if (db) {
                    await addDoc(collection(db, "login_hist"), {
                        version: VERSION_ID,
                        groupId: group,
                        userName: user,
                        timestamp: serverTimestamp(),
                        ip: ip,
                        ua: navigator.userAgent,
                        isAuto: isAuto
                    });
                }

                localStorage.setItem('kajilog_group', group);
                localStorage.setItem('kajilog_user', user);
                showMain(group, user);

            } catch (err) {
                console.error(err);
                btn.disabled = false;
                statusEl.innerText = "接続エラー";
                errorEl.innerText = "Error: " + err.message;
                errorEl.classList.remove('hidden');
                if(isAuto) {
                    localStorage.removeItem('kajilog_group');
                    localStorage.removeItem('kajilog_user');
                }
            }
        };

        function showMain(group, user) {
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-main').classList.add('active');
            document.getElementById('ver-display').innerText = VERSION_ID;
            document.getElementById('main-group-display').innerText = group;
            document.getElementById('main-user-display').innerText = user;
            document.getElementById('login-time-display').innerText = "ログイン時刻: " + new Date().toLocaleString('ja-JP');
        }

        window.logout = () => {
            if(confirm("ログアウトして情報を消去しますか？")) {
                localStorage.removeItem('kajilog_group');
                localStorage.removeItem('kajilog_user');
                location.reload();
            }
        };
    </script>
</body>
</html>
