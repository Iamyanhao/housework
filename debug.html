<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connectivity Debugger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #debug-log {
            font-family: monospace;
            font-size: 12px;
            background: #1a1a1a;
            color: #00ff00;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            border-top: 4px solid #444;
        }
        .log-error { color: #ff5555; }
        .log-info { color: #55aaff; }
        .log-success { color: #55ff55; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <div class="flex-grow p-6">
        <header class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Firebase 接続診断</h1>
            <p class="text-sm text-gray-600">この画面でテスト操作を行い、下のログを確認してください。</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
            <div>
                <h2 class="font-semibold mb-2">1. 接続テスト</h2>
                <button id="btn-connect" class="w-full bg-blue-600 text-white py-2 rounded-lg active:bg-blue-700">Firebase初期化 & 匿名認証</button>
            </div>

            <div>
                <h2 class="font-semibold mb-2">2. データ保存テスト</h2>
                <button id="btn-save" class="w-full bg-green-600 text-white py-2 rounded-lg active:bg-green-700">テストデータを送信</button>
            </div>
        </div>

        <div class="mt-6 text-xs text-gray-500">
            <p>※ Config情報が未設定の場合、必ずエラーになります。</p>
        </div>
    </div>

    <!-- 診断ログ表示エリア -->
    <div id="debug-log">
        <div class="log-info">[System] 診断ログが開始されました。操作を待機中...</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const logElement = document.getElementById('debug-log');
        
        function logger(msg, type = 'info') {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.className = `log-${type} mb-1`;
            div.textContent = `[${time}] ${msg}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // --- ⚠ ここを自分のConfigに書き換える ⚠ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVnIWuGLZdlx2MsyLAfsDgQ2zVkvh8JSc",
  authDomain: "kajilog-135ed.firebaseapp.com",
  projectId: "kajilog-135ed",
  storageBucket: "kajilog-135ed.firebasestorage.app",
  messagingSenderId: "506522172088",
  appId: "1:506522172088:web:c3fe4ad929fc067151d24d"
        };
        // ----------------------------------------

        let app, auth, db;

        document.getElementById('btn-connect').addEventListener('click', async () => {
            try {
                logger("初期化中...", "info");
                
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    throw new Error("Configがデフォルトのままです。自分のIDに書き換えてください。");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                logger("SDK読み込み完了。匿名認証を開始します...", "info");
                
                const result = await signInAnonymously(auth);
                logger(`認証成功！ ユーザーID: ${result.user.uid}`, "success");

            } catch (error) {
                logger(`エラー発生: ${error.message}`, "error");
                console.error(error);
            }
        });

        document.getElementById('btn-save').addEventListener('click', async () => {
            try {
                if (!db) throw new Error("まず「接続テスト」を完了させてください。");

                logger("Firestoreへ書き込み中...", "info");
                
                const docRef = await addDoc(collection(db, "debug_test"), {
                    message: "iPadからのテスト送信",
                    timestamp: serverTimestamp(),
                    device: navigator.userAgent
                });

                logger(`書き込み成功！ ドキュメントID: ${docRef.id}`, "success");
                logger("Firebase ConsoleのFirestoreタブを確認してください。", "success");

            } catch (error) {
                logger(`保存エラー: ${error.message}`, "error");
            }
        });

        // ネットワーク状態の監視
        window.addEventListener('online', () => logger("ネットワークがオンラインになりました", "info"));
        window.addEventListener('offline', () => logger("ネットワークがオフラインです", "error"));

    </script>
</body>
</html>

